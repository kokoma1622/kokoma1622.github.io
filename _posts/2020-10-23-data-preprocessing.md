---
title: "[ML] Data Preprocessing"
date: 2020-10-23 01:48:33 -0400
categories: machine learning, data preprocessing
---

이렇게 모델 목표를 설정하고 설계하려하니, 당장 시작부터 문제가 발생했다.
image도 nlp도 아닌 데이터에 머신 러닝을 적용하는 방법 자체를 몰랐던 것.
논문..논문.. 아무래도 이미지가 익숙하니, non image numeric data to image method를 찾았다.
numeric data들을 정규화시켜, 막대그래프 형태로 표현하여 CNN을 적용하는 논문을 사용하기로 하였다.

적용할 논문을 정해도 문제는 많이 남아있었다.

1. 입력으로 어떤 데이터를 사용할 것인가?

DB를 설계하면서, 나중에 데이터를 사용할 때 필요한 데이터가 누락돼있지 않게 투머치하게 넣었다.
그러다보니 다시 꺼내 쓸 때 정말 필요한 데이터를 정하기 어려웠다.
지금 안 쓰면 앞으로도 안 쓰지 않을까? 라는 아쉬움도 있었고,
솔직히 분 단위로 소유하고 있는 아이템 목록을 코드 짜느라 얼마나 고생했는지를 생각하면 더더욱 그랬다.
가능한 한 많은 데이터를 쓰고는 싶었지만, 그러다보면 막대그래프 1개를 1픽셀로 한다 해도 픽셀 수가 너무 많아지는 문제도 있었다.

이 때 모델의 목적을 명확히 하는 것이 데이터 선택에 도움을 줬다.
모델 사용자가 간편히 접할 수 있는 내용들을 입력으로 하는 것이 좋겠지?
스펠이나 아이템 같은 것을 일일히 카테고리에 맞게 선택하고 있으면 데이터 입력 과정에서 화딱지나지 않을까?
경험치나 골드같은 구체적인 데이터를 게임 도중에 알기는 어렵지않나?
팀 적인 데이터(용, 타워 철거 수 등)들도 알면 도움될 것 같긴 한데, 투머치 아닐까?

결국 인게임에서 탭을 누르면 바로 확인할 수 있는 챔피언, 레벨, cs, kda만 사용하기로 결정했다.
버전과 분은 그 값을 가지는 image 한 장씩을 추가하였다. (3 마지막에 다시 서술)


2. 포지션 간의 상관관계는 어떻게 할 것인가?

처음에는 10명의 정보를 이미지 한 장으로 모두 처리하려 했다.
그러다보니 이미지가 지나치게 커지면서, kernel을 사용하는 CNN 특성 상 10명 데이터 배치에 따라 상관관계 분석이 어려울 수 있었다.
예를 들어 탑-정글-미드-원딜-서폿 순으로 데이터를 배치하면, 인접한 포지션을 제외하고는 시너지를 분석하기 어려웠다.
또한 맞라이너 지표 비교에도 어려운 점이 있었다.
롤은 분명 상대적인 게임이기에 맞라이너보다 확실하게 나은 지표가 있다면 기대승률이 유의미하게 상승하겠지만,
10명의 지표 데이터를 막대그래프 형태로 일자로 배치하는 형태로는 한계가 뚜렷했다.

상관관계 분석을 위해, 막대그래프의 시작을 한 라인에서만 하지 않고, 여러 형태로 해보았다.
예를 들어 기하학적 모양으로 서폿-정글-(엔터)-원딜-미드-탑 으로 배치하면,
서폿정글, 서폿원딜, 원딜미드, 정글미드, 미드탑 시너지 등을 확인할 수 있을 거란 생각이었다.
상대 팀과의 비교를 어떻게 할 것인가도 생각해보았지만, 쉽게 결론이 나지 않았다.

고민을 거듭한 끝에, 유저 별로 막대그래프를 하나씩 만들어, 10차원으로 겹치는 것으로 결정하였다.
상관관계나 맞라인 유저 비교 등은 CNN이 알아서 러닝하는(..) 결과가 나올 것이다.


3. 챔피언은 어떻게 처리할 것인가?

1과 2를 통해, 이미지의 크기를 28x28로 잠정적으로 결정하였다.
아무래도 24가 약수가 많다보니 정규화 스케일링에 편할 것이란 생각도 있었다.
챔피언은 수치 데이터가 아닌 카테고리컬 데이터이기에, 원핫 인코딩이 아니면 표현이 어려웠다.
그런데 챔피언 수가 152개인데 원핫 인코딩을 쓰면 입력 dimension이 너무 커지는 것 같기도 하고,
막대그래프로 표현하기로 한 것과 안 맞기도 했다.

결국 막대그래프에 챔피언을 표시해야 하는데, 처음 생각한 방법은 각 포지션 별 주요 챔피언 47개를 결정한 후,
24 길이의 막대그래프 2줄을 배정하여 원핫 인코딩 느낌으로 47개+기타 로 점을 찍는 것이었다.
그러나 다른 챔피언과 비교하는 상황에서, 한 kernel(5x5 or 7x7)에 잡히지 않을 확률이 매우 높기에, 적절한 방법이 아니라고 생각했다.

결정한 방법은 배경 색상!
152개의 챔피언에 고유 수치 10~161을 랜덤화하여 부여한 후, 막대그래프의 배경에 깔았다.
팀 별로 구분을 주기 위해, 블루 팀은 짝수번째 row만, 레드 팀은 홀수번째 row만 색상을 넣었다.

따라서 이미지의 최종 크기는 10명의 막대그래프 데이터와 분, 버전 값을 가진 28x28x12이 된다.


4. 수치 데이터들의 정규화 방법?

처음에는 10분에 최고/최저 레벨, 최다/최소 킬 등,
해당 분의 최대/최소 데이터 값들을 찾아서 정규화하려 했음.
그러나 공통된 기준을 정하기 어려워서, 해당 게임의 최대/최소 데이터 값을 기준으로 정규화.
최솟값을 1, 최댓값을 24로 하여 유저의 값과 최솟값의 차이를 막대그래프의 길이로 하였다.
단, cs는 분당 cs 3개~11개를 절대적 기준으로 잡아 막대그래프의 길이를 결정하였다.


5. 저장 용량 및 방법은?

마그마챌에 속한 아이디들의 대전기록만 이용하여 게임들을 뽑았으나, 그래도 플래티넘 이하의 게임들도 있었다.
그리고 의외로 평균 마그마챌인 게임은 그렇게 많지 않았다.
적당한 표본 수 확보를 위해, 평균티어 다이아 이상인 게임을 데이터로 사용하였다.
롤드컵 시즌이 다가온 10.20버전부터는 상위권 랭크 게임 수가 현저히 줄어, 버전 당 30000개 정도의 게임 수를 확보할 수 있었다.

게임 하나에 (분)x28x28x12의 크기를 가지고,
일반적인 numpy 계산은 1pixel이 8byte(float64)이기 때문에, 용량이 말도 안 되게 커지는 문제가 발생하였다.
이미지를 직접 만들어보면서 MNIST 저장을 왜 uint8 dtype으로 했는지 깨닫게 되었다.
uint8 dtype으로 각 버전 별 30000개의 게임을 저장하니, 대략 120GB의 용량이 나왔다.
대략 정신이 멍해지는 크기로, 게임 100개 단위로 쪼개서 일단 구글드라이브에 넣어놨다.
다 돈이야.........
